Loci Subsampling - Selecting Loci that support known clades
Analysis notes

GitHub Repo:
https://github.com/LMBiancani/FilterByKnownClades

Written Notes:
https://docs.google.com/document/d/1JuyuBTQ92Tx13pbG4MbDrLy_Qv37Juk4LdzJcGbz2Qw/edit?usp=sharing

Andromeda location:
cd /data/schwartzlab/Biancani/FilterByKnownClades/

Local location:
cd /Users/biancani/Documents/FilterByKnownClades

Alexandra Machine Learning Repo (for simulated loci):
https://github.com/alexandrawalling/PML/tree/main

Local (macbook) directory:
/Users/biancani/Documents/FilterByKnownClades
Andromeda directory:
/data/schwartzlab/Biancani/FilterByKnownClades

2024.05.29

Goal: convert a forked repo to a stand-alone repository without loosing any of the tracked history or contributions.
Create stand-alone repository from Zack's github.

- Fork Zack's Repository: https://github.com/LMBiancani/FilterByKnownClades

Locally:
- Pull all changes in Forked repo to local machine
git clone https://github.com/LMBiancani/FilterByKnownClades

On Github:
- Change the name of the Forked Repository (to anything else ex. "DeleteMe")
- Create a new, empty repo and give it the original name of the Forked Repository

Locally:
- Push all changes to Github (you should not have to do anything special because the new repo now has the same name as
the repo this was originally synced with).
On Github:
- Confirm the new repository contains everything it should
- Delete the forked repository

On Andromeda:
git clone https://github.com/LMBiancani/FilterByKnownClades

add gitignore and include Loci folder

Subset Zack's aligned loci to create test dataset:
/data/schwartzlab/zbergeron/SISRS_mammals/filteredMammalLoci
(101,405 alignments)
ls *11.fasta
(2,780 alignement)

cp /data/schwartzlab/zbergeron/SISRS_mammals/filteredMammalLoci/*11.fasta /data/schwartzlab/Biancani/FilterByKnownClades/Loci/

2024.06.27
Simulations from Alexandra
Simulated loci:
/data/schwartzlab/awalling/Phylo_ML/simulations/empirical/fong/1/alignments3/
/data/schwartzlab/awalling/Phylo_ML/simulations/empirical/liu/1/alignments3/
/data/schwartzlab/awalling/Phylo_ML/simulations/empirical/mcgowen/1/alignments3/
/data/schwartzlab/awalling/Phylo_ML/simulations/empirical/wickett/1/alignments3/

Use copy_data.sh to copy simulated loci to Loci folder (on andromeda only: Data folder listed in gitignore)
deistination folders:
/data/schwartzlab/Biancani/FilterByKnownClades/data/Fong/simulated_loci/
/data/schwartzlab/Biancani/FilterByKnownClades/data/Liu/simulated_loci/
/data/schwartzlab/Biancani/FilterByKnownClades/data/McGowen/simulated_loci/
/data/schwartzlab/Biancani/FilterByKnownClades/data/Wickett/simulated_loci/

tree used for simulations: inferenceEmpirical.iqtree
submission file that generated Empirical trees:
run_iqtree_Fong_empirical.sh
run_iqtree_..._empirical.sh
in...
/data/schwartzlab/awalling/Phylo_ML/datasets/Fong_alignments/
/data/schwartzlab/awalling/Phylo_ML/datasets/Liu_alignments/
/data/schwartzlab/awalling/Phylo_ML/datasets/McGowen_alignments/
/data/schwartzlab/awalling/Phylo_ML/datasets/Wickett_alignments/

Fong:
/data/schwartzlab/awalling/Phylo_ML/datasets/Fong_alignments/inferenceEmpirical.iqtree
cp /data/schwartzlab/awalling/Phylo_ML/datasets/Fong_alignments/inferenceEmpirical.iqtree /data/schwartzlab/Biancani/FilterByKnownClades/data/Fong/emperical_tree/

Liu
/data/schwartzlab/awalling/Phylo_ML/datasets/Liu_alignments/inferenceEmpirical.iqtree
cp /data/schwartzlab/awalling/Phylo_ML/datasets/Liu_alignments/inferenceEmpirical.iqtree /data/schwartzlab/Biancani/FilterByKnownClades/data/Liu/emperical_tree/

Wickett
/data/schwartzlab/awalling/Phylo_ML/datasets/Wickett_alignments/inferenceEmpirical.iqtree
cp /data/schwartzlab/awalling/Phylo_ML/datasets/Wickett_alignments/inferenceEmpirical.iqtree /data/schwartzlab/Biancani/FilterByKnownClades/data/Wickett/emperical_tree/

McGowen
/data/schwartzlab/awalling/Phylo_ML/datasets/McGowen_alignments/inferenceEmpirical.iqtree
cp /data/schwartzlab/awalling/Phylo_ML/datasets/McGowen_alignments/inferenceEmpirical.iqtree /data/schwartzlab/Biancani/FilterByKnownClades/data/McGowen/emperical_tree/

#####

Example submission file for generating emperical trees:
run_iqtree_Fong_empirical.sh
----------
#!/bin/bash
#SBATCH --job-name="IQFong"
#SBATCH --time=96:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=2   # number of nodes
#SBATCH --ntasks-per-node=24   # processor core(s) per node
#SBATCH --mem=250G
#SBATCH --exclusive


cd $SLURM_SUBMIT_DIR

date
#Path to IQTREE executable. Modify with path to your own executable.
iqtree_exe="/home/aknyshov/alex_data/andromeda_tools/iqtree-2.1.2-Linux/bin/iqtree2"


#Concatenate input fasta files and prepare partitions ahead of IQTree run
python3 /home/aknyshov/alex_data/andromeda_tools/AMAS/amas/AMAS.py concat -f fasta -d dna --out-format fasta --part-format raxml -i *fas -c 20 -t concatenatedTrain.fasta -p partitionsTrain.txt

#Run IQtree. Flags: -nt: use 20 CPU cores -spp: specifies partition file but allows partitions to have different evolutionary speeds -pre: specifies prefix for output files -m: determine best fit model immediately followed by tree reconstruction -bb: sets 1000 bootstrap replicates  -alrt: sets 1000 replicates to perform SH-like approximate likelihood test (SH-aLRT)
${iqtree_exe} -nt 20 -s concatenatedTrain.fasta -spp partitionsTrain.txt -pre inferenceEmpirical -m MFP -bb 1000 -alrt 1000


date
---------

2024.07.03

To Do:

- For each simulated locus:
  - infer an unconstrained gene tree, calculate maximum likelihood (completed?)
  - infer a constrained gene tree (constrain "known" clade), calculate maximum likelihood
  - compare likelihoods
    - if constrained is > or = unconstrained, keep LOCUS (else filter locsus)
- Build species tree from filtered simulated Loci
- Build species tree from unfiltered simulated LOCI
- Compare species tree to empirical tree (which is more similar)?

2024.07.10

nano /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/00_iqtree_prep.sh
##########
#!/bin/bash
#SBATCH --job-name="IQprep"
#SBATCH --time=0:30:00  # walltime limit (HH:MM:SS)
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=1   # processor core(s) per node
#SBATCH -c 1
#SBATCH --mem-per-cpu=6G

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# path to IQtree scripts:
scripts_dir=$PROJECT/01_iqtree
# path to aligned loci:
aligned_loci_path=$DATA/$DATASET/simulated_loci
# path to output folder (will be created if doesn't exist):
OUTPUT=$PROJECT/output/$DATASET
# name of iqtree array work folder (will be created if doesn't exist):
array_work_folder=iqtree_assessment
# number of loci per array task
LociPerTask=50

mkdir -p $OUTPUT
cd $OUTPUT
mkdir -p ${array_work_folder}
cd ${array_work_folder}
ls ${aligned_loci_path} | rev | cut -f1 -d/ | rev | split -l $LociPerTask - aligned_loci_list_
arrayN=$(ls aligned_loci_list_* | wc -l)
ls aligned_loci_list_* > array_list.txt
ARRAY="#SBATCH --array=[1-${arrayN}]%40"
echo $ARRAY
echo $ARRAY >> sbatch_array_directive.txt
##########
sbatch -q schwartzlab 00_iqtree_prep.sh
Submitted batch job 329346
Job ID: 329346
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:00:00
CPU Efficiency: 0.00% of 00:00:04 core-walltime
Job Wall-clock time: 00:00:04
Memory Utilized: 0.00 MB (estimated maximum)
Memory Efficiency: 0.00% of 6.00 GB (6.00 GB/core)

output: #SBATCH --array=[1-40]%40
(to be included in subsequent array jobs)

nano /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/01_iqtree_array_gtree.sh
##########
#!/bin/bash
#SBATCH --job-name="IQarr_gtree"
#SBATCH --time=48:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=1   # processor core(s) per node
#SBATCH -c 1
#SBATCH --mem-per-cpu=6G
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL
#SBATCH --array=[1-40]%40

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# path to IQtree scripts:
scripts_dir=$PROJECT/01_iqtree
# path to aligned loci:
aligned_loci_path=$DATA/$DATASET/simulated_loci
# path to output folder (will be created if doesn't exist):
OUTPUT=$PROJECT/output/$DATASET
# name of iqtree array work folder (will be created if doesn't exist):
array_work_folder=$OUTPUT/iqtree_assessment
# path to iqtree executable:
iqtree_exe="/data/schwartzlab/alex/andromeda_tools/iqtree-2.1.2-Linux/bin/iqtree2"

date
cd $array_work_folder
mkdir -p GeneTreesUnconstrained
cd GeneTreesUnconstrained

fileline=$(sed -n ${SLURM_ARRAY_TASK_ID}p $array_work_folder/array_list.txt)
cat ${array_work_folder}/${fileline} | while read line
do
	echo $line
	${iqtree_exe} -nt 1 -s ${aligned_loci_path}/${line} -pre inference_${line} -alrt 1000 -m GTR+G
done
##########
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 329481
Job ID: 329481
Array Job ID: 329481_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: FAILED (exit code 1)
Cores: 1
CPU Utilized: 01:22:53
CPU Efficiency: 98.75% of 01:23:56 core-walltime
Job Wall-clock time: 01:23:56
Memory Utilized: 35.70 MB
Memory Efficiency: 0.58% of 6.00 GB
**** fail due to an error removing output files that did not exist. you can use the -f (force) flag with the rm command to remove a file only if it exists, without throwing an error if it does not. The -f flag tells rm to ignore nonexistent files and arguments, and never prompt for confirmation..
Otherwise output looks fine.


For other loci groups, edit the .sh files and replace "Fong" with the name of one of the other datasets
########## Wickett ##########
for file in $(ls 0*)
do
    sed -i 's/\bFong\b/Wickett/g' "$file"
done
##########
sbatch -q schwartzlab 00_iqtree_prep.sh
Submitted batch job 329523
Job ID: 329523
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:00:00
CPU Efficiency: 0.00% of 00:00:08 core-walltime
Job Wall-clock time: 00:00:08
Memory Utilized: 0.00 MB (estimated maximum)
Memory Efficiency: 0.00% of 6.00 GB (6.00 GB/core)

##########
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 329524
Job ID: 329524
Array Job ID: 329524_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: FAILED (exit code 1)
Cores: 1
CPU Utilized: 01:12:49
CPU Efficiency: 98.78% of 01:13:43 core-walltime
Job Wall-clock time: 01:13:43
Memory Utilized: 45.28 MB
Memory Efficiency: 0.74% of 6.00 GB
**** fail due to an error removing output files that did not exist. you can use the -f (force) flag with the rm command to remove a file only if it exists, without throwing an error if it does not. The -f flag tells rm to ignore nonexistent files and arguments, and never prompt for confirmation..
Otherwise output looks fine.

########## Liu ##########
for file in $(ls 0*)
do
    sed -i 's/\bWickett\b/Liu/g' "$file"
done
##########
sbatch -q schwartzlab 00_iqtree_prep.sh
Submitted batch job 329599
Job ID: 329599
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:00:00
CPU Efficiency: 0.00% of 00:00:09 core-walltime
Job Wall-clock time: 00:00:09
Memory Utilized: 0.00 MB (estimated maximum)
Memory Efficiency: 0.00% of 6.00 GB (6.00 GB/core)
##########
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 329600
Job ID: 329600
Array Job ID: 329600_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:39:25
CPU Efficiency: 98.50% of 00:40:01 core-walltime
Job Wall-clock time: 00:40:01
Memory Utilized: 26.23 MB
Memory Efficiency: 0.43% of 6.00 GB


########## McGowen ##########
for file in $(ls 0*)
do
    sed -i 's/\bLiu\b/McGowen/g' "$file"
done
##########
sbatch -q schwartzlab 00_iqtree_prep.sh
Submitted batch job 329640
Job ID: 329640
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:00:00
CPU Efficiency: 0.00% of 00:00:07 core-walltime
Job Wall-clock time: 00:00:07
Memory Utilized: 0.00 MB (estimated maximum)
Memory Efficiency: 0.00% of 6.00 GB (6.00 GB/core)
##########
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 329641
Job ID: 329641
Array Job ID: 329641_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:35:52
CPU Efficiency: 97.86% of 00:36:39 core-walltime
Job Wall-clock time: 00:36:39
Memory Utilized: 17.40 MB
Memory Efficiency: 0.28% of 6.00 GB

2024.07.11-12
Constrained gene trees:
# IQ-TREE: -g Specify a topological constraint tree file in NEWICK format. The constraint tree can be a multifurcating tree and need not to include all taxa.
#Generate collapsed trees for constrained gene trees
# ex. (A,B,C,D,(E,F,G,H));

Original R script (used to prep the emperical trees for simulations):
  https://github.com/alexandrawalling/PML/blob/main/1_empirical_tree_generation/empirical_tree_processor.R

What this script does:
  part 1 - for each dataset...
  - read emperical trees from Alexandra
  - export emperical trees (after re-rooting) as Author_emperical.tree
  part 2 - for each dataset...
  - read saved emperical tree
  - export CSV table of tip names & numbers as Author_tips.csv
  - export emperical tree with numeric tip labels as Author_num_tips_emperical.tree
  - export emperical tree with combined number & labels on tips as Author_combo_tips_emperical.tree
  - export emperical tree with numbered nodes as Author_num_nodes_emperical.tree
  - export collapsed constrained tree (for constrained gene trees) as Author_constraint.newick

########
module load R-bundle-Bioconductor/3.16-foss-2022b-R-4.2.2
R
#Load in libraries
library(ape)
library(ggplot2)
library(geiger)
library(ggtree)

datasets <- c("Fong","Liu","Wickett","McGowen")

# copy emperical trees from Alexandra:
for (dataset in datasets){
  setwd("/data/schwartzlab/awalling/Phylo_ML")
  tree_path <- paste("simulations/empirical", tolower(dataset), "1/inferenceEmpirical.treefile", sep="/")
  emperical_tree <- read.tree(tree_path)
  #re-root trees (as done by Alexandra before simulating loci):
  if (dataset == "Fong"){
    emperical_tree <- root(emperical_tree, outgroup = "Danio")
  } else if (dataset == "Liu"){
    emperical_tree <- root(emperical_tree, outgroup = "danio_rer")
  } else if (dataset == "Wickett"){
    emperical_tree <- root(emperical_tree, outgroup = "Pyramimonas_parkeae")
  } else if (dataset == "McGowen"){
    # McGowen tree was not re-rooted for simulations
  }
  #Save rerooted emperical tree
  out_path <- paste("/data/schwartzlab/Biancani/FilterByKnownClades/data", dataset, "emperical_tree", sep = "/")
  setwd(out_path)
  filename <- paste(dataset, "emperical.tree", sep = "_")
  #write.tree(emperical_tree, filename)
}

## Pre-processing of emperical trees
for (dataset in datasets){
  ## Read in previously saved emperical tree:
  directory_path <- paste("/data/schwartzlab/Biancani/FilterByKnownClades/data", dataset, "emperical_tree", sep = "/")
  setwd(directory_path)
  emperical_filename <- paste(dataset, "emperical.tree", sep = "_")
  emperical_tree <- read.tree(emperical_filename)
  ## Update tip labels:
  tips <- emperical_tree$tip.label #store original tip labels
  tip_names_tree <- emperical_tree #store tree with original tip labels
  emperical_tree$tip.label <- as.character(1:length(emperical_tree$tip.label)) #replace tip labels with numbers
  tip_nums <- emperical_tree$tip.label #store numbered tip labels
  tip_num_tree <- emperical_tree #store tree with numbered tip labels
  ## Export table of tip names & numbers:
  tips_df <- data.frame(tip_nums, tips)
  filename <- paste(dataset,"tips.csv",sep = "_")
  #write.table(tips_df, file = filename, sep = ",", row.names = FALSE, col.names = FALSE)
  ## Export tree with numbered tips:
  filename <- paste(dataset, "num_tips_emperical.tree", sep = "_")
  #write.tree(tip_num_tree, filename)
  ## Create combined (number & name) tip labels:
  combined_tips <- apply(tips_df, 1, function(row) paste(row, collapse = "_")) #use apply to concatenate strings across rows (margin=1 for rows)
  emperical_tree$tip.label <- combined_tips #Replace tip labels with numbers & names
  combo_tip_tree <- emperical_tree #store tree with combined tip labels
  ## Export tree with combined tip labels:
  filename <- paste(dataset, "combo_tips_emperical.tree", sep = "_")
  #write.tree(combo_tip_tree, filename)
  ## Label nodes with numbers (node numbers start with the number of tips +1):
  num_internal_nodes <- combo_tip_tree$Nnode #number of internal nodes
  num_tips <- Ntip(combo_tip_tree) #number of tips
  node_numbers <- seq((1+num_tips), (1+num_tips+num_internal_nodes)) #generate node numbers
  node_num_tree <- combo_tip_tree #store copy of tree for node numbering
  node_num_tree$node.label <- as.character(node_numbers) #assign sequential numbers to node labels
  ## Export node numbered tree:
  filename <- paste(dataset, "num_nodes_emperical.tree", sep = "_")
  #write.tree(node_num_tree, filename)
  ## Generate collapsed trees for constrained gene trees, ex. (A,B,C,D,(E,F,G,H));
  ## trees with numbered nodes were inspected to ID node corresponding to clade to be constrained.
  ## Fong 46 Turtles (node 140) ## Liu 16 Primates (node 135) ## Wickett 37 Angiosperms/FloweringPlants (node 116) ## McGowen 88 Cetaceans/Ingroup (node 177)
  if (dataset=="Fong"){
    node <- 140
  } else if (dataset=="Liu"){
    node <- 135
  } else if (dataset=="Wickett"){
    node <- 116
  } else if (dataset=="McGowen"){
    node <- 177
  }
  constrained_clade <- extract.clade(tip_num_tree, node) #extract constrained clade from tip numbered tree
  constrained_tip_nums <- constrained_clade$tip.label #store tip numbers for taxa in constrained clade
  unconstrained_tip_nums <- setdiff(tip_nums, constrained_tip_nums) #filter constrained tips from all tips to store unconstrained tips
  ## Generate newick format for constrained tree:
  constrained_newick <- paste("(", (paste(constrained_tip_nums, collapse = ", ")), ")", sep = "")
  unconstrained_newick <- paste(unconstrained_tip_nums, collapse = ", ")
  combined_newick <- paste("(", unconstrained_newick, ",", constrained_newick ,");",sep = "")
  ## Export constrained tree (in newick format)
  filename <- paste(dataset, "constraint.newick", sep = "_")
  #cat(combined_newick, file = filename)
  ## Generate pruned constraint trees for each simulated locus
  loci_path <- paste("/data/schwartzlab/Biancani/FilterByKnownClades/data", dataset, "simulated_loci", sep = "/")
  constraint_path <- paste("/data/schwartzlab/Biancani/FilterByKnownClades/data", dataset, "constraint_trees", sep = "/")
  loci <- list.files(path = loci_path, pattern = "loc*", full.names = FALSE) # list simulated loci filenames
  for (locus in loci) {
    setwd(loci_path)
    locus_lines <- readLines(locus) #read file lines into character vector
    headings <- locus_lines[grepl("^>", locus_lines)]
    taxa <- gsub(">", "", headings) #strip ">" from headings to produce list of taxa
    constrained_tips <- intersect(constrained_tip_nums, taxa) #filter constrained_tip_nums for only entries that also appear in taxa
    unconstrained_tips <- intersect(unconstrained_tip_nums, taxa) #filter unconstrained_tip_nums for only entries that also appear in taxa
    ## Generate newick format for filtered constrained tree:
    constrained_newick <- paste("(", (paste(constrained_tips, collapse = ", ")), ")", sep = "")
    unconstrained_newick <- paste(unconstrained_tips, collapse = ", ")
    combined_newick <- paste("(", unconstrained_newick, ",", constrained_newick ,");",sep = "")
    ## Export constrained tree (in newick format)
    name <- gsub(".fas", "", locus)
    filename <- paste(name,"constraint.newick", sep = "_")
    setwd(constraint_path)
    cat(combined_newick, file = filename)
  }
}

2024.07.12

To do:
-x- Update Dataset variable in iqtree scripts above and update scripts on GitHub
-x- Generate filtered constrained gene trees for each locus (a given locus may not contain all taxa)
-x- create new genetree script for constrained gene trees
-x- run constrained gene trees

2024.07.13

## Constrained Gene Trees

nano /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/02_iqtree_array_constrained_gtree.sh
##########
#!/bin/bash
#SBATCH --job-name="IQarr_gtree"
#SBATCH --time=48:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=1   # processor core(s) per node
#SBATCH -c 1
#SBATCH --mem-per-cpu=6G
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL
#SBATCH --array=[1-40]%40

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# path to IQtree scripts:
scripts_dir=$PROJECT/01_iqtree
# path to aligned loci:
aligned_loci_path=$DATA/$DATASET/simulated_loci
# path to constraint trees
constraint_path=$DATA/$DATASET/constraint_trees
# path to output folder (will be created if doesn't exist):
OUTPUT=$PROJECT/output/$DATASET
# name of iqtree array work folder (will be created if doesn't exist):
array_work_folder=$OUTPUT/iqtree_assessment
# path to iqtree executable:
iqtree_exe="/data/schwartzlab/alex/andromeda_tools/iqtree-2.1.2-Linux/bin/iqtree2"

date
cd $array_work_folder
mkdir -p GeneTreesConstrained

fileline=$(sed -n ${SLURM_ARRAY_TASK_ID}p $array_work_folder/array_list.txt)
cat ${array_work_folder}/${fileline} | while read line
do
	echo $line
  locusID="${line%.fas}"
  CONSTRAINT="${constraint_path}/${locusID}_constraint.newick"
  cd $array_work_folder
	${iqtree_exe} -nt 1 -s ${aligned_loci_path}/${line} -pre GeneTreesConstrained/inference_${line} -alrt 1000 -m GTR+G -g $CONSTRAINT
	#rm -f GeneTreesConstrained/inference_${line}.ckp.gz ## put this line back in - removes a checkpoint file
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330035
Job ID: 330035
Array Job ID: 330035_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:17:50
CPU Efficiency: 99.07% of 01:18:34 core-walltime
Job Wall-clock time: 01:18:34
Memory Utilized: 33.93 MB
Memory Efficiency: 0.55% of 6.00 GB

########## Liu ##########
for file in $(ls 02*)
do
    sed -i 's/\bFong\b/Liu/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330075
Job ID: 330075
Array Job ID: 330075_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:52:22
CPU Efficiency: 98.71% of 00:53:03 core-walltime
Job Wall-clock time: 00:53:03
Memory Utilized: 25.79 MB
Memory Efficiency: 0.42% of 6.00 GB

########## Wickett ##########
for file in $(ls 02*)
do
    sed -i 's/\bLiu\b/Wickett/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330115
Job ID: 330115
Array Job ID: 330115_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:16:54
CPU Efficiency: 98.91% of 01:17:45 core-walltime
Job Wall-clock time: 01:17:45
Memory Utilized: 42.54 MB
Memory Efficiency: 0.69% of 6.00 GB

########## McGowen ##########
for file in $(ls 02*)
do
    sed -i 's/\bWickett\b/McGowen/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330155
Job ID: 330155
Array Job ID: 330155_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:23:23
CPU Efficiency: 97.16% of 00:24:04 core-walltime
Job Wall-clock time: 00:24:04
Memory Utilized: 17.06 MB
Memory Efficiency: 0.28% of 6.00 GB

2024.07.14

For Fong an Liu datasets some output files of the constrained gene trees were in the parent directory
instead of the GeneTreeConstrained directory. Moved Liu files but need to edit
script (above) and rerun for Fong Constrained gene trees. (Wickett was fine). McGowen is missing one gene tree so rerun that as well.

Fong
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330312
Job ID: 330312
Array Job ID: 330312_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:41:18
CPU Efficiency: 98.83% of 01:42:30 core-walltime
Job Wall-clock time: 01:42:30
Memory Utilized: 33.86 MB
Memory Efficiency: 0.55% of 6.00 GB

McGowen
##########
for file in $(ls 02*)
do
    sed -i 's/\bFong\b/McGowen/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330432
Job ID: 330432
Array Job ID: 330432_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:35:57
CPU Efficiency: 97.29% of 00:36:57 core-walltime
Job Wall-clock time: 00:36:57
Memory Utilized: 16.84 MB
Memory Efficiency: 0.27% of 6.00 GB

To Do:
Collect gene trees

########## Collect Constrained Fong Gene Trees ##########
nano /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/03_iqtree_collect_gtrees.sh
##########
#!/bin/bash
#SBATCH --job-name="IQout"
#SBATCH --time=24:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=1   # processor core(s) per node
#SBATCH -c 1
#SBATCH --mem-per-cpu=8G
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# Gene tree type (Constrained or Unconstrained)
GTT="Constrained"
# path to output folder:
OUTPUT=$PROJECT/output/$DATASET
# name of iqtree array work folder (will be created if doesn't exist):
array_work_folder=$OUTPUT/iqtree_assessment
# path to gene Trees
GTREES=$array_work_folder/GeneTrees$GTT

cd $GTREES

date
( > gtrees.txt; cat $array_work_folder/array_list.txt | while read line1; do cat $array_work_folder/${line1} >> gtrees.txt; done )
( > gtrees.tre; cat gtrees.txt | while read line; do cat ./inference_${line}.treefile >> gtrees.tre; done )
dates
##########
sbatch 03_iqtree_collect_gtrees.sh
Submitted batch job 330654
Job ID: 330654
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:00:04
CPU Efficiency: 4.44% of 00:01:30 core-walltime
Job Wall-clock time: 00:01:30
Memory Utilized: 532.00 KB
Memory Efficiency: 0.01% of 8.00 GB


2024.07.15
- need to re-run gene tree because script deleted necessary output filter_SISRS_output (edit script to save all outputs)
##########
Fong Constrained - already fine!
##########
Collect Fong Constrained - already done.
##########
Fong Unconstrained
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 330659
Job ID: 330659
Array Job ID: 330659_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:04:05
CPU Efficiency: 98.72% of 01:04:55 core-walltime
Job Wall-clock time: 01:04:55
Memory Utilized: 35.23 MB
Memory Efficiency: 0.57% of 6.00 GB
##########
Liu Constrained
##########
for file in $(ls 02*)
do
    sed -i 's/\bFong\b/Liu/g' "$file"
done
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330696
Job ID: 330696
Array Job ID: 330696_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:01:16
CPU Efficiency: 98.42% of 01:02:15 core-walltime
Job Wall-clock time: 01:02:15
Memory Utilized: 25.78 MB
Memory Efficiency: 0.42% of 6.00 GB

##########
Liu Unconstrained
##########
for file in $(ls 01*)
do
    sed -i 's/\bFong\b/Liu/g' "$file"
done
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 330697
Job ID: 330697
Array Job ID: 330697_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:50:29
CPU Efficiency: 98.60% of 00:51:12 core-walltime
Job Wall-clock time: 00:51:12
Memory Utilized: 26.23 MB
Memory Efficiency: 0.43% of 6.00 GB

##########
McGowen Constrained
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
for file in $(ls 02*)
do
    sed -i 's/\bLiu\b/McGowen/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330790
Job ID: 330790
Array Job ID: 330790_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:39:50
CPU Efficiency: 97.71% of 00:40:46 core-walltime
Job Wall-clock time: 00:40:46
Memory Utilized: 16.88 MB
Memory Efficiency: 0.27% of 6.00 GB

##########
McGowen Unconstrained
##########
for file in $(ls 01*)
do
    sed -i 's/\bLiu\b/McGowen/g' "$file"
done
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 330830
Job ID: 330830
Array Job ID: 330830_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 00:36:26
CPU Efficiency: 97.90% of 00:37:13 core-walltime
Job Wall-clock time: 00:37:13
Memory Utilized: 17.36 MB
Memory Efficiency: 0.28% of 6.00 GB


##########
Wickett Constrained
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
for file in $(ls 02*)
do
    sed -i 's/\bMcGowen\b/Wickett/g' "$file"
done
##########
sbatch -q schwartzlab 02_iqtree_array_constrained_gtree.sh
Submitted batch job 330870
Job ID: 330870
Array Job ID: 330870_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:24:29
CPU Efficiency: 99.18% of 01:25:11 core-walltime
Job Wall-clock time: 01:25:11
Memory Utilized: 43.19 MB
Memory Efficiency: 0.70% of 6.00 GB

##########
Wickett Unconstrained
##########
for file in $(ls 01*)
do
    sed -i 's/\bMcGowen\b/Wickett/g' "$file"
done
##########
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree
sbatch -q schwartzlab 01_iqtree_array_gtree.sh
Submitted batch job 330885
Job ID: 330885
Array Job ID: 330885_40
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Cores: 1
CPU Utilized: 01:29:52
CPU Efficiency: 99.37% of 01:30:26 core-walltime
Job Wall-clock time: 01:30:26
Memory Utilized: 46.29 MB
Memory Efficiency: 0.75% of 6.00 GB

********* To Do?: ***********
collect Fong unconstrained
collect Liu: constrained, unconstrained
collect McGowen and Wickett, Constrained, unconstrained

Next:
extract maximum likelihood value for each gene tree
compare constrained vs. unconstrained likelihoods

output files with maximum likelihood values:
.log
This log file contains detailed information about the analysis, including the maximum likelihood value.
.iqtree
The .iqtree file, named inference_${line}.iqtree, also contains a summary of the results, including the maximum likelihood value. This file provides a comprehensive report of the analysis, including the final tree, model parameters, and the likelihood score.

Fong constrained
inference_loc_1.fas.ckp.gz
inference_loc_1.fas.iqtree
inference_loc_1.fas.log
inference_loc_1.fas.parstree
inference_loc_1.fas.treefile

inference_loc_1.fas.iqtree:
Log-likelihood of the tree: -6615.7758 (s.e. 195.6494)
Unconstrained log-likelihood (without tree): -4450.5640q

inference_loc_1.fas.log:
Estimate model parameters (epsilon = 0.100)
1. Initial log-likelihood: -7050.771
2. Current log-likelihood: -6645.233
3. Current log-likelihood: -6644.017
Optimal log-likelihood: -6644.016
...
BEST SCORE FOUND : -6615.776

Fong unconstrained
inference_loc_1.fas.bionj   inference_loc_1.fas.iqtree  inference_loc_1.fas.mldist
inference_loc_1.fas.ckp.gz  inference_loc_1.fas.log     inference_loc_1.fas.treefile

inference_loc_1.fas.iqtree
Log-likelihood of the tree: -6510.8087 (s.e. 192.4996)
Unconstrained log-likelihood (without tree): -4450.5640

s.e. = standard error
Compare Overlapping Confidence Intervals: If the confidence intervals of two log-likelihood values overlap, this suggests that there is no statistically significant difference between them. Conversely, if the confidence intervals do not overlap, this indicates that there may be a statistically significant difference between the log-likelihood values.

info needed:
loci_list
unconstrained likelihood
unconstrained se
constrained likelihood
constrained se

Adapt collect gtrees script to also collect likelihood scores and standard error:

nano /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/03_collect_gtree_data.sh
##########
#!/bin/bash
#SBATCH --job-name="IQout"
#SBATCH --time=24:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=1   # processor core(s) per node
#SBATCH -c 1
#SBATCH --mem-per-cpu=8G
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL

module load R/4.0.3-foss-2020b

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to IQtree scripts:
scripts_dir=$PROJECT/01_iqtree
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# path to output folder:
OUTPUT=$PROJECT/output/$DATASET
# name of iqtree array work folder (will be created if doesn't exist):
array_work_folder=$OUTPUT/iqtree_assessment

# generates a list of locus names and collects gene trees

for type in "Constrained" "Unconstrained"
do
  GTT=$type
  GTREES=$array_work_folder/GeneTrees$GTT # path to gene Trees
  cd $GTREES
  date
  ( > gtrees.txt; cat $array_work_folder/array_list.txt | while read line1; do cat $array_work_folder/${line1} >> gtrees.txt; done )
  ( > gtrees.tre; cat gtrees.txt | while read line; do cat ./inference_${line}.treefile >> gtrees.tre; done )
  dates
done

cd $array_work_folder
Rscript ${scripts_dir}/collect_gtrees.R $array_work_folder






NOTE: McGowen GeneTreesConstrained is missing one gene tree. Always use gene tree list from Constrained gene trees for comparisons (it will be the shorter list)


2024.07.16

Concatenated Trees... Unfiltered

#!/bin/bash
#SBATCH --job-name="IQ_CatTree"
#SBATCH --time=12:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=24   # processor core(s) per node
#SBATCH --mem=50G   # total memory
#SBATCH --mail-user="biancani@uri.edu"
#SBATCH --mail-type=ALL


nano Cat_Tree.sh
----------
#!/bin/bash
#SBATCH --job-name="IQ_CatTree"
#SBATCH --time=96:00:00  # walltime limit (HH:MM:SS)
#SBATCH --nodes=1   # number of nodes
#SBATCH --ntasks-per-node=24   # processor core(s) per node
#SBATCH --mem=100G
#SBATCH --exclusive
#SBATCH --mail-user="biancani@uri.edu" #CHANGE THIS to your user email address
#SBATCH --mail-type=ALL

## UPDATE as needed...
# path to Project Directory:
PROJECT=/data/schwartzlab/Biancani/FilterByKnownClades
# path to data directory:
DATA=$PROJECT/data
# Dataset name:
DATASET="Fong"
# path to aligned loci:
aligned_loci_path=$DATA/$DATASET/simulated_loci
# path to output folder (will be created if doesn't exits):
OUTPUT=$PROJECT/output/$DATASET/iqtree_assessment/CatTree_Unfiltered
# path to iqtree executable:
iqtree_exe="/data/schwartzlab/alex/andromeda_tools/iqtree-2.1.2-Linux/bin/iqtree2"
# path to AMAS.py
amas_py="/home/aknyshov/alex_data/andromeda_tools/AMAS/amas/AMAS.py"

mkdir -p $OUTPUT
cd $OUTPUT
date

#Concatenate input fasta files and prepare partitions ahead of IQTree run
python3 $amas_py concat -f fasta -d dna --out-format fasta --part-format raxml -i $aligned_loci_path/*fas -c 24 -t concatenated_loci.fasta -p partitions.txt

#Run IQtree. Flags: -nt: use 24 CPU cores -spp: specifies partition file but allows partitions to have different evolutionary speeds -pre: specifies prefix for output files -m: determine best fit model immediately followed by tree reconstruction -bb: sets 1000 bootstrap replicates  -alrt: sets 1000 replicates to perform SH-like approximate likelihood test (SH-aLRT)
${iqtree_exe} -nt 24 -s concatenated_loci.fasta -spp partitions.txt -pre unfiltered_loci -m MFP -bb 1000 -alrt 1000

date
----------
sbatch -q schwartzlab Cat_Tree.sh
Submitted batch job 331433


Liu Unfiltered Tree:
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/
for file in $(ls Cat*)
do
    sed -i 's/\bFong\b/Liu/g' "$file"
done
sbatch -q schwartzlab Cat_Tree.sh
Submitted batch job 331467
Job ID: 331467
Cluster: andromeda
User/Group: biancani/schwartzlab
State: COMPLETED (exit code 0)
Nodes: 2
Cores per node: 42
CPU Utilized: 8-12:20:51
CPU Efficiency: 38.77% of 21-23:03:12 core-walltime
Job Wall-clock time: 06:16:28
Memory Utilized: 22.53 GB
Memory Efficiency: 4.51% of 500.00 GB

McGowen Unfiltered Tree:
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/
for file in $(ls Cat*)
do
    sed -i 's/\bLiu\b/McGowen/g' "$file"
done
sbatch -q schwartzlab Cat_Tree.sh
Submitted batch job 331468

Wickett Unfiltered tree:
cd /data/schwartzlab/Biancani/FilterByKnownClades/01_iqtree/
for file in $(ls Cat*)
do
    sed -i 's/\bMcGowen\b/Wickett/g' "$file"
done
sbatch -q schwartzlab Cat_Tree.sh
Submitted batch job 331469
