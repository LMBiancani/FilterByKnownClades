---
title: "Notes"
author: "Leann M. Biancani"
output: html_document
---
[GitHub Repository: PlacentalPolytomy](https://github.com/LMBiancani/PlacentalPolytomy)

```{css backgrounds, echo=FALSE}
/* Define a background class for displaying content of slurm submission text files */
.bg_slurm {
  background-color: aliceblue;
  border: 1px solid black;
}
/* Define a background class for displaying content of python text files */
.bg_python {
  background-color: lightyellow;
  border: 1px solid black;
}
/* Define a background class for displaying content of text files */
.bg_text {
  background-color: honeydew;
  border: 1px solid black;
}
/* Define a background class for displaying content of R files */
.bg_R {
  background-color lightsteelblue;
  border: 1px solid black;
}
```

# 1. Filter By Taxa
Scripts are located in the [filterByTaxa](https://github.com/LMBiancani/PlacentalPolytomy/tree/main/filterByTaxa) folder.

* Removes excessively incomplete sequences (ex. sequence must be less than 33% Ns)
* Removes aligned loci with too few taxa represented (ex. locus must include sequences for at least 25 taxa)
* Removes aligned loci with incomplete clade sampling (ex. locus must include a sequence from all 4 taxon groups included in the `groups.csv` file)
* The required taxon-to-group correspondence table, `groups.csv`, is a csv file with the following format: 
```
Group,Taxa
group1,taxonName1
group1,taxonName2
group2,taxonName3
group2,taxonName4
```
### Slurm submission script: `filter_SISRS_output.sh`
* runs the following python script: `filter_SISRS_output.py`
```{bash, comment=NA, echo=FALSE, class.output="bg_slurm"}
cat filterByTaxa/filter_SISRS_output.sh
```
### Python script: `filter_SISRS_output.py`
*  run by previous shell script: `filter_SISRS_output.sh`
```{bash, comment=NA, echo=FALSE, class.output="bg_python"}
cat filterByTaxa/filter_SISRS_output.py
```
### Taxon-to-group table: `groups.csv`
* specify path to this input file in previous shell script: `filter_SISRS_output.sh`
```{bash, comment=NA, echo=FALSE, class.output="bg_text"}
cat filterByTaxa/groups.csv
```

# 2. Annotate Loci
Scripts are located in the [annotation](https://github.com/LMBiancani/PlacentalPolytomy/tree/main/annotation) folder.

* Aligns SISRS loci of a particular taxon to a reference genome (ideally, of the same taxon).
* A custom script is used to retreive a reference taxon for the loci.
* BLAST is run. 
* A custom python script is used to filter the output and convert it to BED. Overlapping hits of similar scores as well as very disjunct alignments are discarded. The BED file is then sorted and intersected with the GFF file for the reference sequence.
* A custom python script then processess the intersected BED file to produce the final output,
either counts of different annotation types, or length proportion of each annotations type. The following types of annotations are recorded: pseudogene, CDS, UTR, intron, lnc_RNA, other (any other type), unannotated (or intergenic).

### Slurm submission script: `download_reference.sh`
* downloads reference genome (FASTA) and annotation (GFF) for Pan troglodytes (chimpanzee) [GCF_002880755.1](https://www.ncbi.nlm.nih.gov/data-hub/genome/GCF_002880755.1/)
```{bash, comment=NA, echo=FALSE, class.output="bg_slurm"}
cat annotation/download_reference.sh
```
### Slurm submission script: `annotation_job.sh`
* runs the following python scripts: `annotation_getTaxContigs.py`, `annotation_blast_parser.py`, `annotation_bed2table.py`
```{bash, comment=NA, echo=FALSE, class.output="bg_slurm"}
cat annotation/annotation_job.sh
```
### Python script: `annotation_getTaxContigs.py`
* run by previous shell script: `annotation_job.sh`
* extracts SISRS loci of a particular taxon into a single file for use with BLAST
```{bash, comment=NA, echo=FALSE, class.output="bg_python"}
cat annotation/annotation_getTaxContigs.py
```
### Python script: `annotation_blast_parser.py`
* BLAST to BED python script run by the previous shell script: `annotation_job.sh`
* adjust parameters on lines 10-12 as needed
```{bash, comment=NA, echo=FALSE, class.output="bg_python"}
cat annotation/annotation_blast_parser.py
```
### Python script: `annotation_bed2table.py`
* BED to table python script run by the previous shell script: `annotation_job.sh`
* two options are provided (to be specified in shell script: `annotation_job.sh`)
1. count the number of each feature per locus (`c`), for ex. 1 CDS, 2 introns, etc.
2. compute proportion of length of each feature type per locus (`l`), for ex. 0.2 CDS, 0.8 introns
```{bash, comment=NA, echo=FALSE, class.output="bg_python"}
cat annotation/annotation_bed2table.py
```

# 3. Assess Locus Properties
## 3.1. AMAS
Scripts are located in the [amas](https://github.com/LMBiancani/PlacentalPolytomy/tree/main/amas) folder.

* Runs AMAS to assess locus features
* **Note:** AMAS takes file names as command line arguments with a limit on how long the line can be. In order to analyze several hundred thousand files, AMAS is run in batches by the driver script (`run_amas.py`).

### Download AMAS
* note path to `AMAS.py` and add path to slurm script `run_amas.sh`
```
git clone https://github.com/marekborowiec/AMAS/
```
### Slurm submission script: `run_amas.sh`
* runs the following python script: `run_amas.py`
```{bash, comment=NA, echo=FALSE, class.output="bg_slurm"}
cat amas/run_amas.sh
```
### Python script: `run_amas.py`
* python script run by shell script: `run_amas.sh`
```{bash, comment=NA, echo=FALSE, class.output="bg_python"}
cat amas/run_amas.py
```

# 4. Asses Phylogenetic Signal: IQ-TREE
Scripts are located in the [iqtree](https://github.com/LMBiancani/PlacentalPolytomy/tree/main/iqtree) folder.

### Slurm submission script: `iqtree_prep.sh`
* sets up the folder and lists of files to process
* generates the array details that need to be added to subsequent array submission scripts
* Note: array details generated by my analysis: `#SBATCH --array=28%28`
```{bash, comment=NA, echo=FALSE, class.output="bg_slurm"}
cat iqtree/iqtree_prep.sh
```


* iqtree_array.sh - slurm script to submit: runs the analyses; **submit using the command output by the previous step in its log file (\*.out)**; adjust paths on lines 16-27 as needed.
* iqtree_array_concat.sh - slurm script to submit: infer concatenation trees
* iqtree_array_gtree.sh - slurm script to submit: infer gene trees
* iqtree_collect_gtrees.sh - slurm script to submit: collect gene tree data
* iqtree_collect_output.sh - slurm script to submit: collect individual fit assessment data
* iqtree_collect_phyloinference_LnL.sh - slurm script to submit: collect concatenation fit assessment data
* trimTrees.R - script to trim taxa off of the main tree(s) depending on the taxon composition of a particular alignment, run by the previous shell script.
* getSCF.R - script to extract sCF values for the branch of interest from IQ-TREE output, run by the previous shell script.